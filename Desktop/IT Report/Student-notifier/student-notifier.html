<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Class Status Notifier</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
        min-height: 100vh;
      }
      .status-card {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .toggle-switch input:checked + .slider {
        background-color: #10b981; /* green-500 */
      }
      .toggle-switch input:checked + .slider:before {
        transform: translateX(100%);
      }
    </style>
  </head>
  <body class="p-4 sm:p-8 flex items-center justify-center">
    <div id="app-container" class="w-full max-w-2xl space-y-8">
      <header class="text-center">
        <h1 class="text-4xl font-extrabold text-indigo-700">
          Class Attendance Notifier
        </h1>
        <p class="text-gray-500 mt-2">
          Real-time status updates for students and staff.
        </p>
      </header>

      <!-- User Info and Status -->
      <div
        class="bg-white p-4 rounded-xl shadow-md flex justify-between items-center text-sm"
      >
        <span class="font-medium text-gray-700">Current User ID:</span>
        <span
          id="user-id-display"
          class="font-mono text-xs p-1 bg-gray-100 rounded-lg text-gray-600 truncate max-w-[70%] sm:max-w-none"
          >Loading...</span
        >
      </div>

      <!-- 1. Real-Time Status Display (Student View) -->
      <div
        class="status-card p-6 rounded-xl bg-white border-b-4 border-gray-300"
      >
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Live Class Status</h2>

        <div
          id="status-indicator"
          class="p-4 rounded-lg flex items-center space-x-3 transition-all duration-500"
        >
          <!-- Status icon/text injected here by JS -->
          <p id="status-message" class="text-lg font-semibold text-white">
            Loading status...
          </p>
        </div>

        <p class="text-sm text-gray-500 mt-4">
          Last updated: <span id="last-updated-time">--</span> by
          <span id="last-updated-user">--</span>
        </p>
      </div>

      <!-- 2. Control Panel (Lecturer/Tutor View) -->
      <div
        class="status-card p-6 rounded-xl bg-white border-b-4 border-indigo-500"
      >
        <h2 class="text-2xl font-bold mb-4 text-indigo-700">
          Update Control Panel
        </h2>
        <p class="text-gray-600 mb-6">
          Toggle the switch to update your attendance status for students.
        </p>

        <div
          class="flex items-center justify-between p-4 bg-indigo-50 rounded-lg"
        >
          <label
            for="status-toggle"
            class="text-lg font-medium text-indigo-800"
          >
            Attendance Status:
            <span id="current-status-text" class="font-extrabold text-green-600"
              >ATTENDING</span
            >
          </label>

          <div class="toggle-switch">
            <label class="relative inline-block w-12 h-6">
              <input
                type="checkbox"
                id="status-toggle"
                class="opacity-0 w-0 h-0"
              />
              <span
                class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-red-400 rounded-full before:absolute before:content-[''] before:h-5 before:w-5 before:left-[2px] before:bottom-[2px] before:bg-white before:rounded-full before:transition-transform before:duration-400"
              ></span>
            </label>
          </div>
        </div>

        <button
          id="update-btn"
          disabled
          class="w-full mt-6 py-3 px-4 bg-gray-400 text-white font-bold rounded-lg transition duration-200 cursor-not-allowed"
        >
          Status Updated
        </button>
      </div>
    </div>

    <!-- Notification Modal (Instead of alert()) -->
    <div
      id="notification-modal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50"
    >
      <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
        <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">
          Error
        </h3>
        <p id="modal-body" class="text-gray-700 mb-4">
          An error occurred while trying to connect to the database.
        </p>
        <button
          onclick="document.getElementById('notification-modal').classList.add('hidden')"
          class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition"
        >
          Close
        </button>
      </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
      // --- JAVASCRIPT LOGIC (Simulates the external script.js file) ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- Global Firebase Variables (Mandatory for Canvas Environment) ---
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : null;
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      let db = null;
      let auth = null;
      let userId = "anon_loading";

      // Firestore Path for Public, Real-time Status
      const STATUS_COLLECTION = `artifacts/${appId}/public/data/class_status`;
      const STATUS_DOC_ID = "current_status";

      // Helper to show custom modal messages
      function showCustomModal(title, message, isError = true) {
        const modal = document.getElementById("notification-modal");
        document.getElementById("modal-title").textContent = title;
        document
          .getElementById("modal-title")
          .classList.toggle("text-red-600", isError);
        document
          .getElementById("modal-title")
          .classList.toggle("text-green-600", !isError);
        document.getElementById("modal-body").textContent = message;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      // --- 1. INITIALIZATION & AUTHENTICATION ---
      async function initializeFirebase() {
        if (!firebaseConfig) {
          console.error("Firebase configuration is missing.");
          showCustomModal(
            "Setup Error",
            "Firebase configuration is not available. Real-time features are disabled.",
            true
          );
          return;
        }

        try {
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }

          onAuthStateChanged(auth, (user) => {
            if (user) {
              userId = user.uid;
              document.getElementById("user-id-display").textContent = userId;
              console.log("User authenticated. UID:", userId);

              // Start listening for status changes only after auth is ready
              listenForStatusChanges();
            } else {
              userId = crypto.randomUUID(); // Fallback identifier
              document.getElementById("user-id-display").textContent =
                userId + " (Anon)";
              console.warn(
                "Authentication failed, using anonymous ID:",
                userId
              );
            }
          });
        } catch (error) {
          console.error("Firebase Initialization Error:", error);
          showCustomModal(
            "Connection Error",
            `Failed to initialize Firebase: ${error.message}`,
            true
          );
        }
      }

      // --- 2. REAL-TIME STATUS LISTENER (STUDENT VIEW) ---
      function listenForStatusChanges() {
        if (!db) return;

        const statusDocRef = doc(db, STATUS_COLLECTION, STATUS_DOC_ID);

        onSnapshot(
          statusDocRef,
          (docSnap) => {
            if (docSnap.exists()) {
              const data = docSnap.data();
              updateStatusDisplay(data);

              // Initialize the control panel toggle to reflect current state
              const toggle = document.getElementById("status-toggle");
              // Check if the toggle state needs updating to prevent unexpected behavior
              if (toggle.checked !== data.isAvailable) {
                toggle.checked = data.isAvailable;
                handleToggleChange(true); // Pass true to indicate external update, preventing update button from being enabled
              }
            } else {
              // Document doesn't exist, set initial state
              updateStatusDisplay({
                isAvailable: true,
                message: "System initialised. Status is ATTENDING by default.",
                lastUpdated: Date.now(),
                updatedByUserId: "System",
                updatedByUserName: "System Admin",
              });

              // Also initialize the database if it's completely missing
              if (auth.currentUser) {
                updateStatus(
                  true,
                  "System initialised. Status is ATTENDING by default."
                );
              }
            }
          },
          (error) => {
            console.error("Firestore listen error:", error);
            showCustomModal(
              "Real-time Error",
              `Could not listen to status changes: ${error.message}`,
              true
            );
          }
        );
      }

      // Function to update the Student View UI
      function updateStatusDisplay(data) {
        const indicator = document.getElementById("status-indicator");
        const statusText = document.getElementById("status-message");
        const statusToggleText = document.getElementById("current-status-text");
        const lastUpdatedTime = document.getElementById("last-updated-time");
        const lastUpdatedUser = document.getElementById("last-updated-user");

        // Apply styling based on status
        if (data.isAvailable) {
          indicator.className =
            "p-4 rounded-lg flex items-center space-x-3 transition-all duration-500 bg-green-500";
          statusText.textContent = `ATTENDING: ${data.message}`;
          statusToggleText.textContent = "ATTENDING";
          statusToggleText.classList.remove("text-red-600");
          statusToggleText.classList.add("text-green-600");
        } else {
          indicator.className =
            "p-4 rounded-lg flex items-center space-x-3 transition-all duration-500 bg-red-500";
          statusText.textContent = `DELAYED/CANCELLED: ${data.message}`;
          statusToggleText.textContent = "NOT ATTENDING";
          statusToggleText.classList.remove("text-green-600");
          statusToggleText.classList.add("text-red-600");
        }

        // Format timestamp
        const date = new Date(data.lastUpdated);
        lastUpdatedTime.textContent = date.toLocaleString();
        lastUpdatedUser.textContent =
          data.updatedByUserName || data.updatedByUserId;
      }

      // --- 3. STATUS UPDATE LOGIC (LECTURER VIEW) ---
      async function updateStatus(isAvailable, message) {
        if (!db || !auth.currentUser) {
          showCustomModal(
            "Authentication Required",
            "Please wait for authentication to complete before updating status.",
            true
          );
          return;
        }

        const newStatus = {
          isAvailable: isAvailable,
          message: message,
          lastUpdated: Date.now(),
          updatedByUserId: auth.currentUser.uid,
          // Mock user name for better display (can be extended with user profiles)
          updatedByUserName: isAvailable
            ? "Lecturer/Tutor (On-time)"
            : "Lecturer/Tutor (Delayed)",
        };

        try {
          const statusDocRef = doc(db, STATUS_COLLECTION, STATUS_DOC_ID);
          await setDoc(statusDocRef, newStatus);
          console.log("Status successfully updated:", newStatus);
          showCustomModal(
            "Success!",
            `Status changed to: ${isAvailable ? "ATTENDING" : "NOT ATTENDING"}`,
            false
          );

          // Disable button and reset styling after successful update
          const btn = document.getElementById("update-btn");
          btn.textContent = "Status Updated";
          btn.classList.add("bg-gray-400", "cursor-not-allowed");
          btn.classList.remove(
            "bg-indigo-600",
            "hover:bg-indigo-700",
            "cursor-pointer"
          );
          btn.disabled = true;
        } catch (error) {
          console.error("Error updating status:", error);
          showCustomModal(
            "Database Write Error",
            `Failed to save status: ${error.message}`,
            true
          );
        }
      }

      // Handles the change in the toggle switch
      function handleToggleChange(isExternalUpdate = false) {
        const toggle = document.getElementById("status-toggle");
        const statusToggleText = document.getElementById("current-status-text");
        const btn = document.getElementById("update-btn");

        const isAvailable = toggle.checked;
        statusToggleText.textContent = isAvailable
          ? "ATTENDING"
          : "NOT ATTENDING";
        statusToggleText.classList.toggle("text-green-600", isAvailable);
        statusToggleText.classList.toggle("text-red-600", !isAvailable);

        // Only enable the update button if the change came from the user interacting with the toggle
        if (!isExternalUpdate) {
          btn.textContent = "Save New Status";
          btn.classList.remove("bg-gray-400", "cursor-not-allowed");
          btn.classList.add(
            "bg-indigo-600",
            "hover:bg-indigo-700",
            "cursor-pointer"
          );
          btn.disabled = false;
        } else {
          // If it's an external update (from Firestore listener), ensure the button is disabled and says "Updated"
          btn.textContent = "Status Updated";
          btn.classList.add("bg-gray-400", "cursor-not-allowed");
          btn.classList.remove(
            "bg-indigo-600",
            "hover:bg-indigo-700",
            "cursor-pointer"
          );
          btn.disabled = true;
        }
      }

      // --- Event Listeners and Initial Load ---
      document.addEventListener("DOMContentLoaded", () => {
        initializeFirebase();

        document
          .getElementById("status-toggle")
          .addEventListener("change", () => handleToggleChange(false));

        document.getElementById("update-btn").addEventListener("click", () => {
          const toggle = document.getElementById("status-toggle");
          const isAvailable = toggle.checked;

          let statusMessage;
          if (isAvailable) {
            statusMessage = "Attending class as scheduled. Please be on time!";
          } else {
            //
            statusMessage =
              "Delayed due to an urgent matter. Class will start 15 minutes late.";
          }

          updateStatus(isAvailable, statusMessage);
        });
      });
    </script>
  </body>
</html>
